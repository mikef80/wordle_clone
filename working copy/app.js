// THIS MAKES THE GAME LOAD ON PAGE LOAD
document.addEventListener('DOMContentLoaded', () => {

    let masterColorArray = [[178,2,24],[222,116,24],[218,43,49],[83,130,49],[189,131,135],[190,37,103],[73,226,47],[222,54,254],[21,249,81],[117,172,140],[142,121,20],[126,30,101],[2,253,2],[164,161,162],[146,103,35],[17,46,230],[183,158,11],[213,37,137],[75,147,91],[181,21,203],[254,209,75],[24,160,86],[20,21,120],[16,189,148],[177,5,85],[226,127,70],[162,109,202],[171,198,28],[38,65,218],[107,219,155],[211,45,65],[104,171,233],[220,71,163],[245,153,189],[14,18,47],[49,85,88],[249,237,174],[106,155,16],[198,230,238],[59,11,78],[160,168,146],[7,238,170],[211,0,137],[239,167,43],[187,18,102],[234,158,92],[243,186,210],[7,158,80],[160,77,15],[235,26,241],[134,66,245],[9,247,147],[243,179,179],[14,46,35],[9,70,93],[218,200,246],[119,124,179],[228,208,226],[37,162,138],[228,43,72],[162,105,0],[242,116,8],[147,74,72],[29,244,243],[147,85,185],[43,79,72],[52,180,123],[212,211,93],[177,55,89],[244,145,150],[37,221,62],[168,228,162],[78,246,165],[29,211,80],[102,133,97],[1,58,36],[15,52,64],[19,242,139],[240,249,27],[82,65,165],[167,242,89],[99,101,151],[101,44,63],[191,204,179],[216,21,131],[108,29,89],[253,39,188],[137,65,201],[202,184,7],[243,35,81],[242,65,0],[150,127,47],[155,229,229],[126,82,116],[190,56,141],[2,222,108],[101,232,51],[124,113,103],[17,37,255],[135,139,53],[209,168,239],[123,94,207],[238,190,135],[101,68,243],[24,224,107],[152,156,127],[223,65,28],[196,108,14],[40,36,233],[36,112,64],[172,113,41],[101,211,232],[82,117,243],[145,204,214],[200,205,4],[229,30,135],[147,202,112],[100,210,51],[212,65,50],[233,92,38],[83,38,126],[32,155,150],[113,199,42],[68,255,85],[99,17,50],[57,178,107],[43,50,205],[56,187,185],[143,147,136],[151,212,62],[201,5,187],[203,77,237],[121,145,132],[151,28,63],[249,219,185],[124,133,215],[165,57,128],[209,16,225],[97,212,21],[84,121,181],[126,183,61],[101,104,3],[208,231,17],[178,144,214],[46,202,121],[107,63,95],[66,196,76],[124,248,92],[88,240,109],[8,124,4],[11,84,176],[170,25,82],[47,226,66],[181,48,130],[112,156,74],[103,209,186],[119,88,111],[202,153,75],[125,207,254],[175,42,187],[146,166,159],[220,88,179],[106,122,222],[93,45,50],[148,23,109],[15,26,81],[199,6,62],[91,251,78],[95,85,102],[82,45,13],[111,152,213],[206,25,1],[221,187,253],[249,188,188],[164,244,201],[211,166,138],[169,39,13],[210,186,132],[252,226,2],[217,180,54],[242,222,23],[116,236,219],[87,146,232],[21,2,74],[177,50,26],[220,240,212],[85,192,135],[108,212,205],[1,113,247],[26,163,53],[117,30,7],[199,5,71],[175,127,197],[114,49,32],[182,72,232],[168,29,253],[60,173,140],[24,169,86],[196,26,18],[108,184,114],[219,116,250],[212,55,156],[132,156,74],[198,61,100],[210,19,3],[150,26,80],[150,126,1],[222,132,79],[224,140,37],[5,41,111],[120,95,64],[206,243,229],[14,16,247],[241,221,79],[6,244,48],[10,136,223],[85,191,205],[252,123,162],[134,171,143],[12,75,46],[51,173,247],[155,120,158],[251,249,60],[157,5,104],[155,68,125],[9,194,47],[28,46,243],[126,31,91],[122,220,131],[136,86,112],[183,89,103],[253,28,164],[112,66,213],[91,116,148],[187,122,125],[248,81,120],[36,170,230],[226,22,152],[249,3,124],[156,19,83],[253,193,35],[126,229,248],[84,97,8],[253,12,158],[209,198,91],[115,37,42],[80,151,38],[139,6,227],[148,70,87],[234,33,235],[26,252,250],[132,151,69],[29,41,241],[7,5,69],[172,68,70],[45,141,168],[101,130,111],[90,8,238],[126,64,18],[154,192,252],[114,138,121],[19,19,6],[28,92,249],[14,209,60],[69,190,213],[168,97,25],[74,112,161],[68,200,191],[4,143,110],[249,148,84],[77,212,18],[215,57,209],[123,210,198],[145,4,16],[147,6,63],[167,131,176],[82,66,27],[67,109,80],[80,160,239],[184,77,30],[6,169,58],[201,218,184],[204,251,69],[72,222,213],[243,190,245],[121,2,208],[163,75,255],[66,242,186],[172,189,47],[194,94,2],[81,129,72],[45,119,234],[105,140,138],[133,72,169],[176,4,97],[244,167,41],[129,232,185],[191,95,191],[248,91,68],[245,53,216],[4,62,96],[180,145,67],[54,135,249],[122,201,233],[186,20,214],[174,225,159],[165,26,139],[191,43,185],[56,37,120],[227,151,6],[36,14,209],[169,122,238],[128,220,50],[148,47,44],[38,102,54],[209,163,53],[116,64,60],[59,108,155],[160,33,29],[137,92,236],[41,6,134],[63,8,137],[226,92,241],[197,16,153],[240,21,18],[59,19,169],[24,98,23],[246,39,225],[35,170,76],[226,238,193],[76,209,181],[128,224,178],[124,36,228],[4,82,56],[213,250,255],[218,168,138],[40,86,119],[49,43,94],[1,212,130],[184,216,161],[58,23,21],[192,80,51],[65,69,16],[97,149,141],[21,22,17],[226,144,43],[79,195,171],[231,247,96],[164,155,58],[196,54,63],[119,81,76],[128,98,39],[241,154,52],[27,185,41],[186,131,214],[17,136,232],[47,209,64],[182,40,159],[186,164,232],[39,156,0],[184,188,110],[149,10,208],[197,86,8],[227,33,66],[191,214,218]];

    


    let answer;
    let outputAnswer;
    // sets number of rows and columns
    const rows = 4;
    const cols = 9;
    let currentLife = 1;
    let checkpoint = 0;
    let currentColour = 0;
    
    buildGrid(3,3);
    setSwatch();
    initLocalStorage();

    const keys = document.querySelectorAll('.keyboard-row button');
    
    const guessedRGB = [[]];
    let currentSquareNo = 1;
    let guessCount = 0;

    function initLocalStorage() {
      // console.log('colour: ' + currentColour);
      const storedCurrentColour = window.localStorage.getItem('currentColour');
      // console.log(storedCurrentColour);
      if (!storedCurrentColour) {
        // console.log('initTrue');
        // console.log(currentColour);
        window.localStorage.setItem('currentColour', currentColour);
      } else {
        // console.log('initFalse');
        currentColour = Number(storedCurrentColour);
      }



    }
    
    function setSwatch() {
        let today = new Date();
        let yearBegin = new Date(2022, 0, 1);
        let msPassed = today - yearBegin;
        let millisecsInDay = 1000 * 60 * 60 * 24;
        let daysPassed = Math.floor(msPassed / millisecsInDay);

        console.log(daysPassed);
        let ansArr = masterColorArray[daysPassed];

        outputAnswer = `rgb(${ansArr[0]},${ansArr[1]},${ansArr[2]})`;
        answer = ansArr.join('')
        
        console.log(outputAnswer);
        console.log(answer);
        
      
    }
    
    // getCurrentGuessArray
    function getCurrentGuessArr() {
      const numbersofGuesses = guessedRGB.length;
      return guessedRGB[numbersofGuesses - 1];
    }

    // updateGuesses
    function updateGuesses(digit) {
      const currentGuessArr = getCurrentGuessArr();

      if(currentGuessArr && currentGuessArr.length < 9) {
          currentGuessArr.push(digit);

          const availableSpaceEl = document.getElementById(String(currentSquareNo));
          currentSquareNo += 1;

          availableSpaceEl.textContent = digit;
      }
    }

    // getTileColour
    function getTileColour(digit, index) {
      // console.log(answer);
      const isCorrectDigit = answer.includes(digit);

      if(!isCorrectDigit) {
        return "rgb(58, 58, 60)";
      }

      const digitInThatPosition = answer.charAt(index);
      const isCorrectPosition = digit === digitInThatPosition;

      if(isCorrectPosition) {
        return "rgb(83, 141, 78)";
      }

      return "rgb(181, 159, 59)";
    }

    // update guess swatch
    function updateGuessSwatch(input) {
      const swatch = document.querySelector('.guess-colour')
      let ColorVal = `rgb(${input[0]}${input[1]}${input[2]},${input[3]}${input[4]}${input[5]},${input[6]}${input[7]}${input[8]})`
      swatch.style.backgroundColor = ColorVal;
      console.log(ColorVal);
    }

    // handleSubmitGuess
    function handleSubmitGuess() {
      const currentGuessArr = getCurrentGuessArr();
      updateGuessSwatch(currentGuessArr);

      if (currentGuessArr.length !== 9) {
        window.alert('Guess must be 9 digits long!');
        return
      }

      const currentGuess = currentGuessArr.join('');
    
      
      const firstDigitId = guessCount * 9 + 1;
      const interval = 200;

      currentGuessArr.forEach((digit, index) => {
        setTimeout(() => {
          const tileColour = getTileColour(digit, index);
          const digitId = firstDigitId + index;
          const digitEl = document.getElementById(digitId);
          digitEl.classList.add('animate__flipInX');
          // digitEl.style = `background-color:${tileColour}; border-color:${tileColour}`;
          digitEl.style = `background-color:${tileColour};`;
        }, interval * index);
      })

      guessCount += 1;
      checkpoint += 9;
      
      if (currentGuess === answer) {
        window.alert('Congratulations!');
        const totalWins = window.localStorage.getItem('totalWins') || 0;
        window.localStorage.setItem('totalWins', Number(totalWins) + 1);
        const currentStreak = window.localStorage.getItem('currentStreak') || 0;
        window.localStorage.setItem('currentStreak', Number(currentStreak) + 1);
        updateTotalGames()
        return;
      }

      if (guessedRGB.length === rows) {
        window.alert(`Sorry, you have no more guesses! The answer is ${outputAnswer}`);
        document.getElementById('test').textContent = outputAnswer;
        window.localStorage.setItem('currentStreak', Number(0));
        updateTotalGames()
        return
      }

      guessedRGB.push([]);

    }


    // update total games
    function updateTotalGames() {
      const totalGames = window.localStorage.getItem('totalGames') || 0;
      window.localStorage.setItem('totalGames', Number(totalGames) + 1);
    }


    // handleDeleteDigit
    function handleDeleteDigit() {
      const currentGuessArr = getCurrentGuessArr();
      const removedDigit = currentGuessArr.pop();

      guessedRGB[guessedRGB.length - 1] = currentGuessArr;

      let lastDigitEl = document.getElementById(Number(currentSquareNo - 1));

      if(lastDigitEl.id != checkpoint) {
        lastDigitEl.textContent = '';
        currentSquareNo = currentSquareNo - 1;
      }
    }


    // BUILD GAME GRID
    function buildGrid(rows,cols) {
      for (let i = 0; i < rows; i++) {
          for (let j = 0; j < cols; j++) {
  
              let square = document.createElement('div');
              let boardOne = document.querySelector('.board-1');
              boardOne.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  
              square.classList.add('square','container','animate__animated');
              square.id = (i * (cols * 3)) + (j + ((0 * cols) + 1));
              square.textContent = `${square.id}`;
              boardOne.appendChild(square);
  
          }
      }
  
      for (let i = 0; i < rows; i++) {
          for (let j = 0; j < cols; j++) {
  
              let square = document.createElement('div');
              let boardTwo = document.querySelector('.board-2');
              boardTwo.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  
              square.classList.add('square','container','animate__animated');
              square.id = (i * (cols * 3)) + (j + ((1 * cols) + 1));
              square.textContent = `${square.id}`;
              boardTwo.appendChild(square);
  
          }
      }
  
      for (let i = 0; i < rows; i++) {
          for (let j = 0; j < cols; j++) {
  
              let square = document.createElement('div');
              let boardThree = document.querySelector('.board-3');
              boardThree.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  
              square.classList.add('square','container','animate__animated');
              square.id = (i * (cols * 3)) + (j + ((2 * cols) + 1));
              square.textContent = `${square.id}`;
              boardThree.appendChild(square);
  
          }
      }
  }


    // MOUSE INPUT NUMBERS INTO GRID
    keys.forEach(key => {
        key.onclick = ({target}) => {
            const number = target.getAttribute('data-key');
                        
            if (number === 'enter') {
                handleSubmitGuess();
                // updateGuessSwatch();
                return;
            }
            
            if (number === 'delete') {
                handleDeleteDigit();
                return;
            }

            // console.log(number);
            updateGuesses(number);
            
        }
    })


    // TOGGLE INFO
    function toggleInfo() {
      let intro = document.querySelector('.intro');
      intro.classList.toggle('show');
    }

    function toggleHelp() {
      console.log('help');
      let help = document.querySelector('.helpdiv');
      console.log(help);
      help.classList.toggle('show');
      console.log(help.classList);
    }

    function toggleStats() {
      let stats = document.querySelector('.stats');
      stats.classList.toggle('show');
    }
    
    // SHOW STUFF
    let showInfo = document.querySelector('.fa-circle-info');
    showInfo.addEventListener('click', toggleInfo);

    let showHelp = document.querySelector('.fa-circle-question');
    showHelp.addEventListener('click', toggleHelp);
    
    let showStats = document.querySelector('.fa-chart-column');
    showStats.addEventListener('click', toggleStats);

    // HIDE STUFF
    let closeInfo = document.querySelector('.intro-close');
    closeInfo.addEventListener('click', toggleInfo);

    let closeHelp = document.querySelector('.help-close');
    closeHelp.addEventListener('click', toggleHelp);
    
    let closeStats = document.querySelector('.stats-close');
    closeStats.addEventListener('click',toggleStats);


    // KEYBOARD INPUT NUMBERS INTO GRID

    window.addEventListener("keyup", key => {
      const number = Number(key.key);

      // console.log(Number.isInteger(number));

      if (!Number.isInteger(number)) {
        console.log('You must enter numbers, not alphabetical characters!');
        return;
      }
                        
      if (number === 'Enter') {
          handleSubmitGuess();
          return;
      }
      
      if (number === 'Delete' || number === 'Backspace') {
          handleDeleteDigit();
          return;
      }

      // console.log(number);
      updateGuesses(number);
    })
})